# NODE JS и Passport
Аутентификация является важной частью любого приложения.
Когда вы используете Passport, то проходите четыре шага, за которые ваше приложение будет ответственно.

1. Страница входа в систему. Страница входа — то место, где пользователь может выбрать метод логина. Если вы используете стороннюю аутентификацию, обычно это просто кнопка или ссылка. Если вы применяете локальную аутентификацию, то будут видны поля имени пользователя и пароля. 

Если пользователь попытается получить доступ к URL, требующему аутентификации (такому как /account в нашем примере), не будучи залогиненным, то, возможно, это будет та страница, на которую вы захотите перенаправлять (альтернативный путь — можете перенаправлять на страницу Не авторизирован со ссылкой на страницу входа в систему).

2. Создать запрос аутентификации. На этом шаге вы создаете запрос, который будет отправлен стороннему сервису через перенаправление. Детали этого запроса сложны и зависят от стратегии аутентификации. Здесь всю тяжелую работу будут выполнять Passport и плагин стратегии. Запрос аутентификации включает защиту от атаки посредника, равно как и от других путей, которыми может пойти злоумышленник. 

Обычно запрос аутентификации непродолжительный, так что вы не можете его сохранить и ожидать, что будете использовать его впоследствии: это помогает предотвратить атаки, ограничивая время, в течение которого злоумышленник может атаковать. В этом месте вы также можете запрашивать дополнительную информацию от механизма сторонней авторизации.

Например, довольно часто запрашивается имя пользователя и, возможно, адрес электронной почты. Учтите, что чем больше информации вы запрашиваете у пользователя, тем меньше вероятность авторизации им вашего приложения.

3. Проверить ответ аутентификации. Предположим, пользователь авторизовал
ваше приложение и вы возвращаетесь назад с подтвержденным ответом аутентификации от стороннего сервиса, что подтверждает личность вашего пользователя. Еще раз: детали этой проверки сложны и будут обрабатываться Passport и плагином стратегии. Если ответ аутентификации указывает, что пользователь не авторизирован (если были введены неправильные учетные данные или ваше приложение не было авторизовано пользователем), вам следует выполнить перенаправление на соответствующую страницу (либо обратно на страницу логина, либо на страницу Не авторизирован или Не удалось авторизировать).

В ответ аутентификации будут включены идентификатор для пользователя,
уникальный для конкретного стороннего сервиса, любые другие данные, которые вы запрашивали на шаге 2. Для разрешения шага 4 мы должны «запомнить», что пользователь авторизирован. Обычный способ это сделать — установить переменную сессии, включающую идентификатор пользователя, указывающую, таким образом, что эта сессия уже авторизирована (можно использовать и cookie, хотя я рекомендую применять сессии).

4. Проверить авторизацию. На шаге 3 мы записали идентификатор пользователя в этой сессии. Наличие этого идентификатора позволяет нам получить объект пользователя из базы данных, содержащий информацию о том, какие функции этот пользователь авторизован выполнять. Таким образом, нет необходимости выполнять стороннюю аутентификацию для каждого запроса. Эта задача проста, и для ее решения нам больше не нужен Passport — у нас есть собственный объект пользователя, содержащий наши собственные правила аутентификации.

Если этот объект недоступен, значит, запрос не авторизован и мы можем перенаправлять на страницу логина или на страницу Не авторизирован.

### Установка зависимостей

> Установка express & body-parser:

```sh
$ npm install --save express
$ npm i --save body-parser
```

> Установка path:

```sh
$ npm install --save path
```

> Установка handlebars:

```sh
$ npm install --save express-handlebars
```

> Установка mongoose:

```sh
$ npm install --save mongoose
```

### Инициализация модулей

> Инициализация handlebars в app.js:
```js
const express = require('express');

const app = express();
// Установка механизма представления handlebars
const handlebars = require('express-handlebars').create({ defaultLayout:'main' });
app.engine('handlebars', handlebars.engine);
app.set('view engine', 'handlebars');
```

Создадим шаблон для нашего сайта. Создайте файл  views/layouts/main.handlebars:
```html
<!doctype html>
<html>
<head>
 <title>Home page</title>
</head>
<body>
 {{{body}}}
</body>
</html>
```
Теперь создадим страницы представления для нашей домашней страницы, views/
home.handlebars:
```html
<h1>Добро пожаловать Home page!</h1>
```
и так далее для каждой страницы.

Теперь, когда мы установили представления, необходимо заменить старые 
маршруты новыми, использующими эти представления:
```js
app.get('/', function(req, res) {
 res.render('home');
});

app.get('/about', function(req, res) {
 res.render('about');
});

// Обобщенный обработчик 404 (промежуточное ПО)
app.use(function(req, res, next){
 res.status(404);
 res.render('404');
});

### Подключение к MongoDB
Добавляем импорты в app.js
```js
const mongoose = require('mongoose');
const url = 'mongodb+srv://user:password@cluster0.tw5x2.mongodb.net/db-name'
mongoose.connect(url, {useNewUrlParser: true, useUnifiedTopology: true})
```
При этом необходимо будет добавить user,password,db-name для подключения к mongodb.

Создаем модель для пользователей в user.js
```js
const mongoose = require('mongoose');

const userSchema = mongoose.Schema({
 authId: String,
 name: String,
 email: String,
 role: String,
 created: Date,
});

const User = mongoose.model('User', userSchema);
module.exports = User;
```

Для того чтобы сохранить данные пользователя в БД необходимо использовать маршрут:POST и метод .save();
```js
app.post('/signup', async function(req, res){
    const user = new User({
        email: req.body.email,
        password: req.body.password
    });

    try {
        await user.save();
        res.redirect('/');
    } catch(error){
        console.log(error);
    }
})
```
